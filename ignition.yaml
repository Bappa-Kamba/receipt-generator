apps:
  - script: ./dist/main.js
    name: ECOMMERCE-RECEIPT-GENERATOR
    watch: false
    instances: 1           # Automatically use all available CPU cores
    exec_mode: fork       # Enables clustering for load distribution
    max_memory_restart: 400M # Automatically restart the app if memory exceeds 400MB
    autorestart: true        # Auto-restart the app if it crashes
    restart_delay: 5000      # Add a delay (in milliseconds) before restarting the app to avoid rapid restarts
    env:
      NODE_ENV: production   # Set environment variables for production
      NODE_CLUSTER_SCHED_POLICY: "least_conn"
      LOGGER: true
      NO_COLOR: true
    node_args:
      - "--max-old-space-size=800"   # Limit the V8 heap size to manage memory usage better
      - "--expose-gc"                # Expose GC to manually trigger garbage collection if necessary
    error_file: .pm2/logs/ecommerce-receipt-generator-error.log # Log errors
    out_file: .pm2/logs/ecommerce-receipt-generator-output.log  # Log output
    log_date_format: 'YYYY-MM-DD HH:mm Z' # Date format for logs
    merge_logs: true         # Merge logs from all instances
    log_type: json           # Log in JSON format for better parsing and monitoring
    exp_backoff_restart_delay: 100   # Use exponential backoff for restarts to handle repeated failures gracefully
    min_uptime: 10000         # Consider the app stable if it runs for at least 5 seconds
    max_restarts: 10         # Limit the number of restarts within a certain timeframe
    wait_ready: true         # Wait until the app sends a signal of readiness before considering it started
    kill_timeout: 1600       # Give the app time to clean up during shutdown
    instance_var: INSTANCE_ID # Use a unique ID for each instance
